<!DOCTYPE html><html lang="en" class="aspect-16-9"><head><meta charset="UTF-8"><meta name="generator" content="Asciidoctor 0.1.4, dzslides backend"><title>Characterization Tests with JUnit</title><meta name="author" content="Jakub Marchwicki"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic&amp;subset=latin,latin-ext&amp;family=Cedarville+Cursive"><link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css"><link rel="stylesheet" href="./dzslides/themes/highlight/tomorrow.css"><link rel="stylesheet" href="./dzslides/themes/style/stormy-jm.css"><style>section:not(.topic) > h2 { display: none;}</style><link rel="stylesheet" href="./dzslides/core/dzslides.css"><link rel="stylesheet" href="./dzslides/themes/transition/fade.css"></head><body><section class="title"><h1>Characterization Tests with JUnit</h1><footer><span class="author">Jakub Marchwicki</span><span class="divider">&nbsp;&middot;&nbsp;</span><span class="author">@kubem</span></footer></section><section><img class="pull-right" src="images/YDP_logo_screen.png" alt="YDP logo screen">
<p>Jakub Marchwicki</p>
<div class="literalblock"><pre class="literal">* Young Digital Planet (YDP)
  A Digital Publishing in Education

* I'm Chief Almighty Architect there ;-)
  Kind of

* 10+ years in IT
* Past 2 years in management
** Gradually recovering

* I don't claim this ideas perfect.
** It was good enough in context
** I'm happy to discuss it and ritualy dissent them</pre></div></section>
<section class="topic recap red-border"><h2>Rule #1</h2><p class="statement">The is no such thing as legacy<br>
If not used - abandon<br>
If you can&#8217;t - business as usual<br>
<span class="pull-right"><strong>cope with it!</strong></span></p>
<details><details open=""><ul><li>And I was in such situation</li><li>At the begining it looked very simple</li></ul></details></details></section>
<section><img class="frame" src="images/commitstrip.jpg" alt="commitstrip"></section>
<section><ul><li>HR System</li></ul>
<p>24 java classes (<strong>sic!</strong>)<br>
3k lines of code<br>
2600 JSP files<br>
700k lines of code of JSP files</p></section>
<section><ul class="pull-right"><li>Project mgmt</li></ul>
<p class="pull-right text-right">Noone cared about it since 2007<br>
Ruby 1.8 + Rail 1.2<br>
Migrating to Ruby 2.0 and Rails 3.2</p></section>
<section><img src="images/diag-78d7a58a6c0eeb7e8099d76c48ea50d7.png" alt="Diagram">
<details><details open=""><ul><li>an HR system (custom built)</li><li>project portfolio management system (in house built)</li><li>SOAP webservice communication</li></ul></details></details></section>
<section><div class="listingblock"><pre class="highlight"><code class="jsp">&lt;table border='0' width='100%' style="margin-top:15px;"&gt;
&lt;tr&gt;&lt;td valign='top' width="200" align="center"&gt;

&lt;% byte[] encoded = null;
String prac_pnr =(String)session.getAttribute("prac_pnr");
if (prac_pnr ==null) prac_pnr ="";

YdpPssClient client = new YdpPssClient();
String logaid=prac_pnr;
encoded = client.getUserFotoFromWServices("",logaid,"small");
session.setAttribute("encoded",encoded);
Manager.refresh(LAOSL1,(String)session.getAttribute("AKPN"));
%&gt;
&lt;%if(encoded!= null){%&gt;
  &lt;IMG src="loadImgTh_02.jsp" border="0" id="test"&gt;
&lt;%}else{%&gt;
    &lt;IMG height="177" src="pics/noImage.jpg" border="0" id="test"&gt;
&lt;%}%&gt;
&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</code></pre></div>
<details><details open=""><ul><li>I like 20 different places and JSP files</li></ul></details></details></section>
<section class="topic recap red-border"><h2>Rule #2</h2><p class="statement">When not <strong>manual</strong><br>
 consider it <strong>safe</strong></p>
<details><details open=""><ul><li>automatic refactoring, replacing class with another</li><li>wrapping or decorating legacy class with a new one</li><li>to be replaced</li><li>we keep the interface, delegate, start testing</li></ul></details></details></section>
<section class="topic"><h2>The test looks badly</h2><div class="listingblock"><pre class="highlight"><code class="java">WebServiceWrapper client = new WebServiceWrapper();

System.out.println("SERVICE:getUserEmployment#####################");
String[][] result = client.getUserEmployment(key, userid, dt1, dt2);

for (int i = 0; i &lt; result.length; i++) {
  for (int j = 0; j &lt; result[i].length; j++) {
    System.out.print("USER_EMPLOYMENT: [" + i + "][" + j + "]: ");
    System.out.println(result[i][j]);
  }
}
System.out.println();</code></pre></div>
<details><details open=""><ul><li>That&#8217;s officially worst code snipper ever shown on this conference</li><li>But at least it shows someting</li><li>It&#8217;s like a characteristics of our class / method</li></ul></details></details></section>
<section><blockquote class="small quote"><p>A characterization test is a mean to describe (characterize) the actual behavior of an existing piece of software.</p><em>Working Effectively with Legacy Code</em><br><cite>Michael Feathers</cite></blockquote>
<details><details open=""><ul><li>if we run such test again and again, repeativly, through many different data sets</li><li>It&#8217;ll at least tell us if we are doing something wrong</li></ul></details></details></section>
<section class="topic"><h2>Simplistic use case</h2><div class="listingblock"><div class="title"><code>BusinessCode.java</code></div><pre class="highlight"><code class="java">public class BusinessClass {

  public String businessMethod(String param) {
    return param.split(" ")[0];
  }

}</code></pre></div></section>
<section><div class="listingblock"><div class="title"><code>BusinessCodeTest.java</code></div><pre class="highlight"><code class="java">public class BusinessClassTest {

  @ClassRule
  public static CharacterizationRule rule =
        aRuleFor(BusinessClassTest.class)
        .build();

  private BusinessClass service = new BusinessClass();

  @Test
  public void just_run_the_method() {
    final String param = "first parameter"
    System.out.println("param = " + param);
    String output = service.businessMethod(param);
    System.out.println("after split = " + output);
  }
}</code></pre></div>
<details><details open=""><ul><li>No Runners, @RunWith is so 2000</li><li>ClassRule / just Rule - doesn&#8217;t matter</li><li>I suggest to keep it single responsible and run a single logger for all methods</li><li>The whole idea is to have a single test code and change the behaviour</li></ul></details></details></section>
<section class="topic"><h2>Two modes: logging and verify</h2><div class="listingblock"><pre class="highlight"><code class="java">final public static String ENV_NAME_FOR_RECORDING = "pinchpoint";

private boolean isRecording() {
  String env = System.getProperty(ENV_NAME_FOR_RECORDING);
  return (env != null);
}</code></pre></div>
<div class="listingblock"><div class="title"><code>runit.sh</code></div><pre class="highlight"><code class="shell">mvn test -Dpinchpoint=true -Dtest=BusinessCodeTest</code></pre></div>
<details><details open=""><ul><li>We run exactly the same code<ul><li>one time logging</li><li>the other verifing if everything worked fine</li></ul></li><li>After initial logging we can start chenging class<ul><li>Looking if the output hasn&#8217;t changed - it shouldn&#8217;t</li></ul></li></ul></details></details></section>
<section class="topic"><h2>External Resource</h2><blockquote class="small quote"><p>A base class for Rules that set up an external resource before a test and tear it down afterward.</p></blockquote></section>
<section><div class="listingblock"><pre class="highlight"><code class="java">public class FileOutputCapture extends ExternalResource {

  protected void before() throws Throwable {
    original = System.out;
    PrintStream pos = new PrintStream(capturedStream);
    System.setOut(pos);
  }

  protected void after() {
    System.setOut(original);
    try {
      Files.write(outputFile.toPath(),
              capturedStream.toByteArray(),
              StandardOpenOption.APPEND);
    } catch (IOException e) {
        throw new RuntimeException("File write failed! ", e);
    }
  }
}
</code></pre></div></section>
<section class="topic"><h2>Do my maven thing again</h2><div class="listingblock"><div class="title"><code>runit.sh</code></div><pre class="highlight"><code class="shell">mvn test -Dtest=BusinessCodeTest</code></pre></div></section>
<section class="topic"><h2>Verification phase: capture again</h2><div class="listingblock"><div class="title"><code>Capture</code></div><pre class="highlight"><code class="java">public class StreamOutputCapture extends ExternalResource {
  PrintStream original;

  protected void before() throws Throwable {
    original = System.out;
    PrintStream pos = new PrintStream(capturedStream);
    System.setOut(pos);
  }

  protected void after() {
    System.setOut(original);
  }
}</code></pre></div></section>
<section class="topic"><h2>Verifier</h2><blockquote class="small quote"><p>Verifier is a base class for Rules like ErrorCollector, which turns passing test methods into failing tests if a verification check is failed</p></blockquote></section>
<section class="topic"><h2>and verify</h2><div class="listingblock"><div class="title"><code>Verify</code></div><pre class="highlight"><code class="java">public class CaptureVerifier extends Verifier {

  protected void verify() throws Throwable {
    List&lt;String&gt; actual = ReadLines.fromStream(capturedStream);
    List&lt;String&gt; original = ReadLines.fromFile(pinchFile);

    Patch&lt;String&gt; patch = DiffUtils.diff(original, actual);

    assertThat(patch, is(empty()));
  }
}
</code></pre></div></section>
<section class="topic"><h2>Results?</h2><div class="listingblock"><pre class="highlight"><code class="txt">java.lang.AssertionError:
File:
  &lt;/tmp/com.example.BusinessClassTest.txt&gt;
read with charset &lt;UTF-8&gt; does not have the expected content:
line: &lt;3&gt;, expected:&lt;something&gt; but was:&lt;something else&gt;
  at com.example.BusinessClassTest.should_create_master_output_file</code></pre></div></section>
<section><p class="pull-right">How I felt<br>
<strong>when started</strong></p>
<img class="frame" src="images/doogie1.jpg" alt="doogie1"></section>
<section><p class="pull-right">How I felt<br>
<strong>when doing it</strong></p>
<img class="frame" src="images/doogie2.jpg" alt="doogie2"></section>
<section><img class="frame" src="images/doogie3.jpg" alt="doogie3">
<details><details open=""><ul><li>Like Sławek Sobótka used to say</li><li>We are in this shit up to head</li><li>But we are not afraid to kneel down</li></ul></details></details></section>
<section class="topic ending"><h2 class="name">Thank you!</h2><p class="footer"><em class="icon-twitter">&#8203;</em> @kubem</p></section>
<section class="topic"><h2>Links and other goodies</h2><div class="listingblock"><pre class="highlight"><code class="groovy">dependencies {
  runtime 'pl.marchwicki:junit-characterization:0.3'
}</code></pre></div>
<div class="listingblock"><pre>
http://speakerdeck.com/kubamarchwicki/characterization-tests

http://jakub.marchwicki.pl/posts
      /2015/01/30/characterize-your-legacy-junit-rules/

Follow me on twitter
  @kubem

The junit characterization rules
  https://github.com/kubamarchwicki/junit-characterization

This presentation was made with AsciiDoctor
  https://github.com/kubamarchwicki/presentations/</pre></div></section><script src="./dzslides/core/dzslides.js"></script><script src="./dzslides/highlight/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script></body></html>